# Required for Grafana Live WebSocket connections
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

upstream grafanaui {
  server 127.0.0.1:3000;
}

server {
  listen 80;
  server_name performance.speedcloud.co.in;
  return 301 https://$server_name$request_uri;
}

server {
  listen 443 ssl;
  server_name performance.speedcloud.co.in;

  ssl_certificate /etc/letsencrypt/live/performance.speedcloud.co.in/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/performance.speedcloud.co.in/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

  # ---------------- GRAFANA (AUTH PROXY) ----------------
  location / {
    proxy_pass http://localhost:5050/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /grafana {
    auth_request /__auth_grafana;

    # 2) Capture the username header returned by Flask auth endpoint
    auth_request_set $webauth_user $upstream_http_x_webauth_user;

    # Security: never trust any client-sent header
    proxy_set_header X-WEBAUTH-USER "";

    # 3) Inject identity header to Grafana
    proxy_set_header X-WEBAUTH-USER $webauth_user;
    proxy_set_header Authorization "";
    proxy_pass http://grafanaui;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /__auth_grafana {
    internal;

    proxy_pass http://127.0.0.1:5050/auth/grafana; # your Flask endpoint

    # auth_request subrequest doesn't need body
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";

    # Make sure Flask can see the user's session cookie
    proxy_set_header Cookie $http_cookie;

    # Optional debug/context
    proxy_set_header X-Original-URI $request_uri;
  }

  # ---- Grafana Live WebSocket (MUST be under /grafana) ----
  location /api/live/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_pass http://grafanaui/api/live/;
  }

  location /api/monitoring/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $host;
    proxy_pass http://localhost:5050/api/monitoring/;
  }
}
