{% extends "layout.html" %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="m-0">Administration — Users</h1>

  <div class="d-flex gap-2">
    <input id="searchInput"
           type="text"
           class="form-control"
           placeholder="Search users…"
           style="width:320px;">

    {% if can("manage_users") %}
    <button class="btn btn-info text-white"
            data-bs-toggle="offcanvas"
            data-bs-target="#addUserCanvas">
      + Add User
    </button>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0" id="usersTable">
      <thead class="table-light">
        <tr>
          <th>Username</th>
          <th>Customer</th>
          <th>Role</th>
          <th>Admin</th>
          <th>Status</th>
          <th style="width:120px;">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="text-muted" id="paginationInfo"></div>
  <div>
    <button class="btn btn-sm btn-outline-secondary" id="prevPage">Prev</button>
    <span class="mx-2" id="pageIndicator"></span>
    <button class="btn btn-sm btn-outline-secondary" id="nextPage">Next</button>
  </div>
</div>

<!-- ================= ADD USER ================= -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="addUserCanvas">
  <div class="offcanvas-header">
    <h5>Add User</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="addUserForm">
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input class="form-control" name="username" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" class="form-control" name="password" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Customer</label>
        <select class="form-select" name="customer_id" id="customerSelect" required></select>
      </div>

      <div class="mb-3">
        <label class="form-label">Role</label>
        <select class="form-select" id="roleSelect" required></select>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="isAdminCheck">
        <label class="form-check-label">Global Admin</label>
      </div>

      <button class="btn btn-success w-100">Create User</button>
    </form>
  </div>
</div>

<!-- ================= EDIT USER ================= -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="editUserCanvas">
  <div class="offcanvas-header">
    <h5>Edit User</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form id="editUserForm">
      <input type="hidden" id="editUserId">

      <div class="mb-3">
        <label class="form-label">Role</label>
        <select class="form-select" id="editRoleSelect" required></select>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="editIsAdminCheck">
        <label class="form-check-label">Global Admin</label>
      </div>

      <button class="btn btn-primary w-100">Save Changes</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let allUsers = [];
let filteredUsers = [];
let currentPage = 1;
const pageSize = 25;

/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", () => {
  loadUsers();
  loadRoles();
  loadCustomers();
  document.getElementById("searchInput").addEventListener("input", applySearch);
  document.getElementById("prevPage").onclick = () => changePage(-1);
  document.getElementById("nextPage").onclick = () => changePage(1);
});

/* ================= USERS ================= */
function loadUsers() {
  fetch("/api/admin/users")
    .then(r => r.json())
    .then(resp => {
      allUsers = resp.data || [];
      filteredUsers = allUsers;
      currentPage = 1;
      renderTable();
    });
}

function applySearch() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  filteredUsers = allUsers.filter(u =>
    u.username.toLowerCase().includes(q) ||
    u.customer.toLowerCase().includes(q) ||
    (u.roles[0] || "").toLowerCase().includes(q)
  );
  currentPage = 1;
  renderTable();
}

function renderTable() {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * pageSize;
  const pageData = filteredUsers.slice(start, start + pageSize);

  pageData.forEach(u => {
    tbody.innerHTML += `
      <tr>
        <td>${u.username}</td>
        <td>${u.customer}</td>
        <td>${u.roles[0] || "-"}</td>
        <td>${u.is_admin ? "Yes" : "No"}</td>
        <td>
          <span class="badge ${u.is_active ? "bg-success" : "bg-secondary"}">
            ${u.is_active ? "Active" : "Disabled"}
          </span>
        </td>
        <td class="text-nowrap">
          <i data-lucide="edit-3"
             class="me-2 text-primary cursor-pointer"
             title="Edit"
             onclick="openEditUser(${u.id}, '${u.roles[0] || ""}', ${u.is_admin})"></i>

          <i data-lucide="${u.is_active ? "pause-circle" : "play-circle"}"
             class="${u.is_active ? "text-danger" : "text-success"} cursor-pointer"
             title="${u.is_active ? "Disable" : "Enable"}"
             onclick="toggleUser(${u.id})"></i>
        </td>
      </tr>`;
  });

  lucide.createIcons();
  updatePaginationInfo();
}

function changePage(delta) {
  const maxPage = Math.ceil(filteredUsers.length / pageSize);
  currentPage = Math.min(Math.max(1, currentPage + delta), maxPage);
  renderTable();
}

function updatePaginationInfo() {
  const maxPage = Math.ceil(filteredUsers.length / pageSize) || 1;
  document.getElementById("pageIndicator").textContent =
    `Page ${currentPage} of ${maxPage}`;
  document.getElementById("paginationInfo").textContent =
    `${filteredUsers.length} users`;
}

/* ================= TOGGLE ================= */
function toggleUser(id) {
  if (!confirm("Change user status?")) return;
  fetch(`/api/admin/users/${id}/toggle`, { method: "POST" })
    .then(() => loadUsers());
}

/* ================= ROLES & CUSTOMERS ================= */
function loadRoles() {
  fetch("/api/admin/roles")
    .then(r => r.json())
    .then(resp => {
      roleSelect.innerHTML = editRoleSelect.innerHTML = "";
      resp.data.forEach(r => {
        roleSelect.innerHTML += `<option value="${r.name}">${r.name}</option>`;
        editRoleSelect.innerHTML += `<option value="${r.name}">${r.name}</option>`;
      });
    });
}

function loadCustomers() {
  fetch("/api/admin/customers")
    .then(r => r.json())
    .then(resp => {
      customerSelect.innerHTML = "";
      resp.data.forEach(c =>
        customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`
      );
    });
}

/* ================= ADD ================= */
addUserForm.onsubmit = e => {
  e.preventDefault();
  fetch("/api/users/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: addUserForm.username.value,
      password: addUserForm.password.value,
      customer_id: addUserForm.customer_id.value,
      roles: [roleSelect.value],
      is_admin: isAdminCheck.checked
    })
  }).then(() => {
    bootstrap.Offcanvas.getInstance(addUserCanvas).hide();
    addUserForm.reset();
    loadUsers();
  });
};

/* ================= EDIT ================= */
function openEditUser(id, role, isAdmin) {
  editUserId.value = id;
  editRoleSelect.value = role;
  editIsAdminCheck.checked = isAdmin;
  new bootstrap.Offcanvas(editUserCanvas).show();
}

editUserForm.onsubmit = e => {
  e.preventDefault();
  fetch(`/api/admin/users/${editUserId.value}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      role: editRoleSelect.value,
      is_admin: editIsAdminCheck.checked
    })
  }).then(() => {
    bootstrap.Offcanvas.getInstance(editUserCanvas).hide();
    loadUsers();
  });
};
</script>
{% endblock %}

