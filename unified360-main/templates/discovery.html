{% extends "layout.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
  <h1 class="m-0">Network Discovery</h1>
  <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#jobDrawer">
    + New Discovery Job
  </button>
</div>

<!-- ========== DISCOVERY JOBS ========== -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-bold">
    Discovery Jobs
  </div>

  <div class="p-2">
    <input id="jobSearch" class="form-control" placeholder="Search jobs by name, IP, server...">
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Monitoring Server</th>
          <th>IP Range</th>
          <th>SNMP Version</th>
          <th>Status</th>
          <th>Last Run</th>
          <th style="width: 140px;">Actions</th>
        </tr>
      </thead>
      <tbody id="jobRows">
        <tr><td colspan="7" class="text-center text-muted py-4">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center p-2 border-top">
    <div id="jobPageMeta" class="small text-muted"></div>
    <div class="d-flex gap-1">
      <button id="jobPrev" class="btn btn-sm btn-outline-secondary">Prev</button>
      <button id="jobNext" class="btn btn-sm btn-outline-secondary">Next</button>
    </div>
  </div>
</div>

<!-- ========== DISCOVERED ASSETS ========== -->
<div class="card shadow-sm">
  <div class="card-header bg-light fw-bold">
    Discovered Assets
  </div>

  <div class="p-2">
    <input id="assetSearch" class="form-control" placeholder="Search assets by IP, hostname, vendor...">
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>IP Address</th>
          <th>Hostname</th>
          <th>Vendor</th>
          <th>Model</th>
          <th>Type</th>
          <th>SNMP Profile</th>
          <th>Reachable</th>
        </tr>
      </thead>
      <tbody id="assetRows">
        <tr><td colspan="7" class="text-center text-muted py-4">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center p-2 border-top">
    <div id="assetPageMeta" class="small text-muted"></div>
    <div class="d-flex gap-1">
      <button id="assetPrev" class="btn btn-sm btn-outline-secondary">Prev</button>
      <button id="assetNext" class="btn btn-sm btn-outline-secondary">Next</button>
    </div>
  </div>
</div>

<!-- ========== DRAWER: NEW JOB ========== -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="jobDrawer">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">New Discovery Job</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <form id="jobForm" class="row g-3">

      <!-- Job Name -->
      <div class="col-12">
        <label class="form-label fw-semibold">Job Name</label>
        <input name="name" class="form-control" required>
      </div>

      <!-- Monitoring Server -->
      <div class="col-12">
        <label class="form-label fw-semibold">Monitoring Server</label>
        <select name="monitoring_server" id="monitoringServer" class="form-select" required></select>
      </div>

      <!-- IP Range -->
      <div class="col-12">
        <label class="form-label fw-semibold">IP Range</label>
        <input name="ip_range" class="form-control" required>
        <div class="form-text">
          Supported: Single IP (10.10.10.10), Range (10.10.10.1-10.10.10.254), CIDR (10.10.10.0/24)
        </div>
      </div>

      <!-- SNMP Version -->
      <div class="col-12">
        <label class="form-label fw-semibold">SNMP Version</label>
        <select name="snmp_version" id="snmpVersion" class="form-select">
          <option value="v2c">v2c</option>
          <option value="v3">v3</option>
        </select>
      </div>

      <!-- v2 -->
      <div class="col-12 v2c-field">
        <label class="form-label fw-semibold">Community String</label>
        <input name="community" class="form-control" placeholder="public">
      </div>

      <!-- v3 fields -->
      <div class="col-12 v3-field d-none">
        <label class="form-label fw-semibold">V3 Username</label>
        <input name="v3_username" class="form-control">
      </div>

      <div class="col-12 v3-field d-none">
        <label class="form-label fw-semibold">Auth Protocol</label>
        <select name="v3_auth_protocol" class="form-select">
          <option value="MD5">MD5</option>
          <option value="SHA">SHA</option>
        </select>
      </div>

      <div class="col-12 v3-field d-none">
        <label class="form-label fw-semibold">Auth Password</label>
        <input name="v3_auth_password" type="password" class="form-control">
      </div>

      <div class="col-12 v3-field d-none">
        <label class="form-label fw-semibold">Privacy Protocol</label>
        <select name="v3_priv_protocol" class="form-select">
          <option value="AES">AES</option>
          <option value="DES">DES</option>
        </select>
      </div>

      <div class="col-12 v3-field d-none">
        <label class="form-label fw-semibold">Privacy Password</label>
        <input name="v3_priv_password" type="password" class="form-control">
      </div>

      <div id="jobErrors" class="text-danger small"></div>

      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
        <button class="btn btn-primary" type="submit">Save Job</button>
      </div>

    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ========== SNMP VERSION FIELD TOGGLE ========== */
  const snmpSel = document.getElementById("snmpVersion");
  function toggleSNMP() {
    const isV3 = snmpSel.value === "v3";
    document.querySelectorAll(".v2c-field").forEach(e => e.classList.toggle("d-none", isV3));
    document.querySelectorAll(".v3-field").forEach(e => e.classList.toggle("d-none", !isV3));
  }
  snmpSel.addEventListener("change", toggleSNMP);
  toggleSNMP();

  /* ========== LOAD MONITORING SERVERS ========== */
  async function loadServers() {
    const sel = document.getElementById("monitoringServer");
    sel.innerHTML = '<option>Loadingâ€¦</option>';

    const res = await fetch('/api/proxy-servers?per_page=500');
    const data = await res.json();

    sel.innerHTML = '';
    data.items.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.ip_address;
      opt.textContent = s.location ? `${s.location} - ${s.dc_name}` : s.ip_address;
      sel.appendChild(opt);
    });
  }

  /* ========== PAGINATION STATE ========== */
  let jobState = {page: 1, per_page: 10, q: ""};
  let assetState = {page: 1, per_page: 10, q: ""};

  /* ========== LOAD JOBS ========== */
  async function loadJobs() {
    const q = new URLSearchParams(jobState).toString();
    const res = await fetch(`/api/discovery-jobs?${q}`);
    const data = await res.json();
    const rows = document.getElementById("jobRows");
    rows.innerHTML = "";

    if (!data.items.length) {
      rows.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No jobs</td></tr>';
    } else {
      data.items.forEach(j => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${j.name}</td>
          <td>${j.monitoring_server}</td>
          <td>${j.ip_range}</td>
          <td>${j.snmp_version}</td>
          <td>${j.status}</td>
          <td>${j.last_run || "-"}</td>
          <td>
            <button class="btn btn-sm btn-success trigger" data-id="${j.id}">Run</button>
            <button class="btn btn-sm btn-danger delete" data-id="${j.id}">Delete</button>
          </td>
        `;
        rows.appendChild(tr);
      });

      document.querySelectorAll(".delete").forEach(btn => {
        btn.onclick = async () => {
          if (!confirm("Delete this discovery job?")) return;
          await fetch(`/api/discovery-jobs/${btn.dataset.id}`, {method: "DELETE"});
          loadJobs();
        };
      });

      document.querySelectorAll(".trigger").forEach(btn => {
        btn.onclick = async () => {
          await fetch(`/api/discovery-jobs/${btn.dataset.id}/trigger`, {method: "POST"});
          loadJobs();
        };
      });
    }

    document.getElementById("jobPageMeta").textContent =
      `Page ${data.page} of ${data.pages}`;
    document.getElementById("jobPrev").disabled = data.page <= 1;
    document.getElementById("jobNext").disabled = data.page >= data.pages;
  }

  /* ========== LOAD ASSETS ========== */
  async function loadAssets() {
    const q = new URLSearchParams(assetState).toString();
    const res = await fetch(`/api/discovery-assets?${q}`);
    const data = await res.json();
    const rows = document.getElementById("assetRows");

    rows.innerHTML = "";

    if (!data.items.length) {
      rows.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No assets</td></tr>';
    } else {
      data.items.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.ip}</td>
          <td>${a.hostname || "-"}</td>
          <td>${a.vendor || "-"}</td>
          <td>${a.model || "-"}</td>
          <td>${a.device_type || "-"}</td>
          <td>${a.snmp_profile || "-"}</td>
          <td>${a.snmp_reachable ? "Yes" : "No"}</td>
        `;
        rows.appendChild(tr);
      });
    }

    document.getElementById("assetPageMeta").textContent =
      `Page ${data.page} of ${data.pages}`;
    document.getElementById("assetPrev").disabled = data.page <= 1;
    document.getElementById("assetNext").disabled = data.page >= data.pages;
  }

  /* ========== FORM SUBMIT ========== */
  document.getElementById("jobForm").onsubmit = async (e) => {
    e.preventDefault();
    const f = e.target;
    const data = Object.fromEntries(new FormData(f).entries());

    const res = await fetch("/api/discovery-jobs", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });

    if (res.ok) {
      bootstrap.Offcanvas.getInstance(document.getElementById("jobDrawer")).hide();
      loadJobs();
      f.reset();
    } else {
      const err = await res.json();
      document.getElementById("jobErrors").textContent = JSON.stringify(err.errors || err.error);
    }
  };

  /* ========== SEARCH EVENTS ========== */
  document.getElementById("jobSearch").oninput = (e) => {
    jobState.q = e.target.value;
    jobState.page = 1;
    loadJobs();
  };

  document.getElementById("assetSearch").oninput = (e) => {
    assetState.q = e.target.value;
    assetState.page = 1;
    loadAssets();
  };

  /* ========== PAGINATION EVENTS ========== */
  document.getElementById("jobPrev").onclick = () => { jobState.page--; loadJobs(); };
  document.getElementById("jobNext").onclick = () => { jobState.page++; loadJobs(); };

  document.getElementById("assetPrev").onclick = () => { assetState.page--; loadAssets(); };
  document.getElementById("assetNext").onclick = () => { assetState.page++; loadAssets(); };

  /* ========== INIT ========== */
  loadServers();
  loadJobs();
  loadAssets();

});
</script>

{% endblock %}

