{% extends "layout.html" %}
{% block content %}

<script>
  window.CURRENT_USER = {{ session.get('user')|tojson }};
</script>

<style>
  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.8rem;
  }
  .status-up { background-color: #d1f5d3; color: #0a0; }
  .status-down { background-color: #f8d7da; color: #c00; }
  .small-muted { font-size: 0.85rem; color: #666; }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="m-0">IIS Monitoring</h1>

  <div class="d-flex align-items-center gap-2">
    <select id="customerFilter" class="form-select form-select-sm" style="width:200px;">
      <option value="All">All Customers</option>
    </select>

    <input id="searchInput" class="form-control form-control-sm"
           style="width:320px;" placeholder="Search by Instance, Site, or App">

    <label class="form-check-label small ms-2">
      <input type="checkbox" id="toggleInactive" class="form-check-input me-1">
      Show sites inactive &gt;7 days
    </label>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light" id="tableHead"></thead>
      <tbody id="tableBody">
        <tr><td colspan="7" class="text-center text-muted py-4">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex align-items-center justify-content-between p-2 border-top">
    <div id="pageMeta" class="small text-muted">Page 0 of 0</div>
    <div class="d-flex gap-1">
      <button id="prevBtn" class="btn btn-outline-secondary btn-sm">Prev</button>
      <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const GRAFANA_BASE = {{ GRAFANA_BASE_URL | tojson }};
  const customerFilter = document.getElementById("customerFilter");
  const searchInput = document.getElementById("searchInput");
  const toggleInactive = document.getElementById("toggleInactive");
  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("tableBody");
  const pageMeta = document.getElementById("pageMeta");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  toggleInactive.checked = false;

  let page = 1, per_page = 25, total_pages = 1;
  let q = "";
  let show_inactive = toggleInactive.checked;
  let dataItems = [];
  let allCustomers = JSON.parse(localStorage.getItem("allCustomersIIS") || "[]");

  function debounce(fn, ms = 300){
    let t;
    return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); };
  }

  function timeAgo(iso){
    if(!iso || iso==="N/A") return "N/A";
    const sec=Math.round((Date.now()-new Date(iso))/1000);
    if(sec<60) return sec+"s ago";
    if(sec<3600) return Math.round(sec/60)+"m ago";
    if(sec<86400) return Math.round(sec/3600)+"h ago";
    return Math.round(sec/86400)+"d ago";
  }

  function populateCustomers(list){
    const names = (list || []).filter(Boolean);
    allCustomers = [...new Set([...allCustomers, ...names])].sort();
    localStorage.setItem("allCustomersIIS", JSON.stringify(allCustomers));

    const current = customerFilter.value || "All";
    customerFilter.innerHTML =
      `<option value="All">All Customers</option>` +
      allCustomers.map(c=>`<option value="${c}">${c}</option>`).join("");

    if(allCustomers.includes(current)) customerFilter.value = current;
  }

  function renderHead(){
    tableHead.innerHTML = `
      <tr>
        <th>Customer</th>
        <th>Instance</th>
        <th>Site</th>
        <th>App</th>
        <th>Last Update</th>
        <th>Status</th>
        <th class="text-center">Action</th>
      </tr>`;
  }

  function renderRows(){
    tableBody.innerHTML="";
    if(!dataItems.length){
      tableBody.innerHTML=`<tr><td colspan="7" class="text-center text-muted py-4">No results</td></tr>`;
      return;
    }

    dataItems.forEach(it=>{
      const isDown = it.status === "DOWN";
      const row = `
        <tr>
          <td>${it.customer_name || ""}</td>
          <td>${it.instance || ""}</td>
          <td>${it.site || ""}</td>
          <td>${it.app || "—"}</td>
          <td>${timeAgo(it.last_update)}</td>
          <td><span class="status-badge ${isDown?"status-down":"status-up"}">${isDown?"DOWN":"UP"}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary grafana"
              data-customer="${it.customer_name || ""}"
              data-host="${it.instance || ""}"
              data-site="${it.site || ""}"
              data-app="${it.app || ""}">
              <i data-lucide="bar-chart-2" width="16"></i>
            </button>
          </td>
        </tr>`;
      tableBody.insertAdjacentHTML("beforeend", row);
    });

    if(window.lucide) lucide.createIcons();
  }

  tableBody.addEventListener("click", e=>{
    const btn = e.target.closest(".grafana");
    if(!btn) return;

    const dash = "iismonitoring";
    const url =
      `${GRAFANA_BASE}/d/${dash}` +
      `?var-customer=${encodeURIComponent(btn.dataset.customer || "")}` +
      `&var-instance=${encodeURIComponent(btn.dataset.host || "")}` +
      `&var-site=${encodeURIComponent(btn.dataset.site || "")}` +
      `&var-app=${encodeURIComponent(btn.dataset.app || "")}` +
      `&kiosk`;

    openGrafanaModal(url, `IIS Monitoring — ${btn.dataset.host} — ${btn.dataset.site}`);
  });

  function load(){
    fetch(`/api/monitored-iis?` + new URLSearchParams({
      page, per_page,
      q,
      show_inactive: show_inactive ? "true" : "false",
      customer: customerFilter.value || "All"
    }))
    .then(r=>r.json())
    .then(d=>{
      const items = d.items || [];
      total_pages = d.pages || 1;

      dataItems = items;
      populateCustomers(d.customers || []);
      renderHead();
      renderRows();
      pageMeta.textContent = `Page ${page} of ${total_pages}`;
    })
    .catch(()=>{
      tableBody.innerHTML=`<tr><td colspan="7" class="text-center text-danger py-4">Failed to load</td></tr>`;
    });
  }

  customerFilter.addEventListener("change",()=>{page=1;load();});

  toggleInactive.addEventListener("change",()=>{
    show_inactive = toggleInactive.checked;
    page=1;
    load();
  });

  searchInput.addEventListener("input", debounce(()=>{
    q = (searchInput.value || "").trim();
    page=1;
    load();
  }, 350));

  prevBtn.addEventListener("click",()=>{ if(page>1){ page--; load(); } });
  nextBtn.addEventListener("click",()=>{ if(page<total_pages){ page++; load(); } });

  renderHead();
  load();
});
</script>

{% endblock %}
